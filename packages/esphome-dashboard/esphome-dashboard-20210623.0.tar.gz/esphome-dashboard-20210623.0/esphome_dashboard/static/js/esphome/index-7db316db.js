$(document).ready((function(){M.AutoInit(document.body),o(),f()}));const e=window.location,t=new URL("./",`${e.protocol}//${e.host}${e.pathname}`);t.protocol="ws:","https:"===e.protocol&&(t.protocol="wss:");const n=t.href,o=()=>{const e=document.querySelectorAll("#nodes .card").length,t=document.querySelector("#nodes #grid");e<=3?t.classList.add("grid-1-col"):e<=6?t.classList.add("grid-2-col"):t.classList.add("grid-3-col")};let a=null,s=!1,c=null,d=!1,i=!1;const l=document.querySelector("#js-editor-modal #js-editor-area"),r=ace.edit(l);r.setOptions({highlightActiveLine:!0,showPrintMargin:!0,useSoftTabs:!0,tabSize:2,useWorker:!1,theme:"ace/theme/dreamweaver",mode:"ace/mode/yaml"}),r.commands.addCommand({name:"saveCommand",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(){g(a)},readOnly:!1});const u=e=>{a=e;document.querySelector("#js-editor-modal #js-node-filename").innerHTML=a;const t=document.querySelector("#js-editor-modal [data-action='save']"),n=document.querySelector("#js-editor-modal [data-action='upload']"),o=document.querySelector("#js-editor-modal [data-action='close']");t.setAttribute("data-filename",a),n.setAttribute("data-filename",a),n.onclick=()=>g(a),"secrets.yaml"===a?(n.classList.add("disabled"),s=!0):(n.classList.remove("disabled"),s=!1),o.setAttribute("data-filename",a);const c=document.querySelector("#js-editor-modal #js-loading-indicator"),d=document.querySelector("#js-editor-modal #js-editor-area");c.style.display="block",d.style.display="none",r.setOption("readOnly",!0),fetch(`./edit?configuration=${a}`,{credentials:"same-origin"}).then((e=>e.text())).then((e=>{r.setValue(e,-1),r.setOption("readOnly",!1),c.style.display="none",d.style.display="block"})),r.focus();const i=document.getElementById("js-editor-modal");M.Modal.init(i,{onOpenStart:function(){},onCloseStart:function(){m()},dismissible:!1}).open()};document.querySelectorAll("[data-action='edit']").forEach((e=>{e.addEventListener("click",(e=>{u(e.target.dataset.filename)}))}));const m=()=>{a=null},f=()=>{c=new WebSocket(`${n}ace`),c.addEventListener("message",(e=>{const t=JSON.parse(e.data);if("line"===t.event){const e=JSON.parse(t.data);if("result"===e.type){const t=[];for(const n of e.validation_errors){let e={text:n.message,type:"error",row:0,column:0};null!=n.range&&(e.row=n.range.start_line,e.column=n.range.start_col),t.push(e)}for(const n of e.yaml_errors)t.push({text:n.message,type:"error",row:0,column:0});r.session.setAnnotations(t),t.length?document.querySelector("#js-editor-modal [data-action='upload']").classList.add("disabled"):document.querySelector("#js-editor-modal [data-action='upload']").classList.remove("disabled"),i=!1}else"read_file"===e.type&&p({type:"file_response",content:r.getValue()})}})),c.addEventListener("open",(()=>{const e=JSON.stringify({type:"spawn"});c.send(e)})),c.addEventListener("close",(()=>{c=null,setTimeout(f,5e3)}))},p=e=>{let t=JSON.stringify({type:"stdin",data:JSON.stringify(e)+"\n"});c.send(t)};r.session.on("change",((e,t)=>{let n;return function(){let o=this,a=arguments,s=function(){n=null,e.apply(o,a)};clearTimeout(n),n=setTimeout(s,t)}})((()=>{d=!s}),250)),setInterval((()=>{d&&!i&&null!=c&&(p({type:"validate",file:a}),i=!0,d=!1)}),100);const g=e=>{const t=new RegExp("(?:.([^.]+))?$");".yaml"===e.match(t)[0]?fetch(`./edit?configuration=${e}`,{credentials:"same-origin",method:"POST",body:r.getValue()}).then((e=>{e.text()})).then((()=>{M.toast({html:`‚úÖ Saved <code class="inlinecode">${e}</code>`,displayLength:1e4})})).catch((t=>{M.toast({html:`‚ùå An error occured saving <code class="inlinecode">${e}</code>`,displayLength:1e4})})):M.toast({html:`‚ùå File <code class="inlinecode">${e}</code> cannot be saved as it is not a YAML file!`,displayLength:1e4})};document.querySelectorAll("[data-action='save']").forEach((e=>{e.addEventListener("click",(e=>{g(a)}))})),document.querySelectorAll("[data-action='delete']").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.getAttribute("data-filename");fetch(`./delete?configuration=${t}`,{credentials:"same-origin",method:"POST"}).then((e=>{e.text()})).then((()=>{const e=`<span>üóëÔ∏è Deleted <code class="inlinecode">${t}</code>\n                           <button class="btn-flat toast-action">Undo</button>`,n=M.toast({html:e,displayLength:1e4}).el.querySelector(".toast-action");document.querySelector(`.card[data-filename="${t}"]`).remove(),n.addEventListener("click",(()=>{fetch(`./undo-delete?configuration=${t}`,{credentials:"same-origin",method:"POST"}).then((e=>{e.text()})).then((()=>{window.location.reload(!1)}))}))}))}))}));const y=async(e,t)=>{t||(t={}),t.credentials="same-origin";const n=await fetch(e,t);if(!n.ok)throw new Error(`Request not successful (${n.status})`);return"application/json"===n.headers.get("content-type")?n.json():n.text()};class h extends Error{}const v=(e,t,n,o)=>{const a=new URL(`./${e}`,location.href);a.protocol="http:"===a.protocol?"ws:":"wss:";const s=new WebSocket(a.toString());return o&&o.signal.addEventListener("abort",(()=>s.close())),new Promise(((e,o)=>{s.addEventListener("message",(t=>{const a=JSON.parse(t.data);if("line"===a.event&&n)n(a.data);else if("exit"===a.event)if(0===a.code)e(void 0);else{const e=new h(`Error compiling configuration (${a.code})`);e.code=a.code,o(e)}})),s.addEventListener("open",(()=>{s.send(JSON.stringify({type:"spawn",...t}))})),s.addEventListener("close",(()=>{o(new Error("Unexecpted socket closure"))}))}))};let E,S;const L=[],w=e=>{L.push(e);const t=()=>{const t=L.indexOf(e);-1!==t&&(L.splice(t),0===L.length&&(clearTimeout(E),E=void 0,S=void 0))};if(L.length>1){if(S){const t=S;setTimeout((()=>e(t)),0)}return t}return E=window.setTimeout(b,2e3),t},b=async()=>{const e=(new Date).getTime()+2e3;try{S=await y("./ping");for(const e of L)e(S)}finally{if(void 0!==E){const t=Math.max(0,e-(new Date).getTime());E=window.setTimeout(b,t)}}},q=()=>import("./c.6a89748f.js").then((function(e){return e.i})),j=e=>{q();const t=document.createElement("esphome-install-dialog");t.configuration=e,document.body.append(t)},A=()=>import("./c.4c2b1138.js"),k=()=>{A(),document.body.append(document.createElement("esphome-wizard-dialog"))},O=()=>import("./c.203ca935.js"),x=()=>import("./c.3f371dad.js"),T=()=>import("./c.f95210f5.js"),J=()=>import("./c.8f85baad.js"),N=()=>{J(),document.body.append(document.createElement("esphome-update-all-dialog"))},_=()=>import("./c.06ac1473.js").then((function(e){return e.l}));document.querySelectorAll("[data-action='wizard']").forEach((e=>{e.addEventListener("click",k),e.addEventListener("mouseover",A,{once:!0})})),w((e=>{for(let t in e){let n=document.querySelector(`#nodes .card[data-filename="${t}"]`);if(null===n)continue;let o,a=e[t];if(null===a)o="status-unknown";else if(!0===a)o="status-online",n.setAttribute("data-last-connected",Date.now().toString());else if(n.hasAttribute("data-last-connected")){const e=parseInt(n.getAttribute("data-last-connected"));o=Date.now()-e<=5e3?"status-not-responding":"status-offline"}else o="status-offline";n.classList.contains(o)||(n.classList.remove("status-unknown","status-online","status-offline","status-not-responding"),n.classList.add(o))}})),document.querySelectorAll("[data-action='upload']").forEach((e=>{e.addEventListener("click",(e=>j(e.target.dataset.filename))),e.addEventListener("mouseover",q,{once:!0})})),document.querySelectorAll("[data-action='validate']").forEach((e=>{e.addEventListener("click",(e=>(e=>{O();const t=document.createElement("esphome-validate-dialog");t.configuration=e,document.body.append(t)})(e.target.dataset.filename))),e.addEventListener("mouseover",O,{once:!0})})),document.querySelectorAll("[data-action='clean']").forEach((e=>{e.addEventListener("click",(e=>(e=>{x();const t=document.createElement("esphome-clean-dialog");t.configuration=e,document.body.append(t)})(e.target.dataset.filename))),e.addEventListener("mouseover",x,{once:!0})})),document.querySelectorAll("[data-action='clean-mqtt']").forEach((e=>{e.addEventListener("click",(e=>(e=>{T();const t=document.createElement("esphome-clean-mqtt-dialog");t.configuration=e,document.body.append(t)})(e.target.dataset.filename))),e.addEventListener("mouseover",T,{once:!0})})),document.querySelectorAll("[data-action='update-all']").forEach((e=>{e.addEventListener("click",N),e.addEventListener("mouseover",J,{once:!0})})),document.querySelectorAll("[data-action='logs']").forEach((e=>{e.addEventListener("click",(e=>(e=>{_();const t=document.createElement("esphome-logs-target-dialog");t.configuration=e,document.body.append(t)})(e.target.dataset.filename))),e.addEventListener("mouseover",_,{once:!0})}));export{w as a,j as b,y as f,u as o,v as s};
