import{x as t}from"./c.3b87a103.js";const e=t=>{let e=[];for(let a of t)219==a?e=e.concat([219,221]):192==a?e=e.concat([219,220]):e.push(a);return e},a=t=>{let e=[];for(let a=0;a<t.length;a++){let i=t.charCodeAt(a);i<=255&&e.push(i)}return e},i=(t,...e)=>{let a=0;if(t.replace(/[<>]/,"").length!=e.length)throw new Error("Pack format to Argument count mismatch");let i=[],s=!0;const r=(t,e)=>{for(let a=0;a<e;a++)s?i.push(t>>8*a&255):i.push(t>>8*(e-a)&255)};for(let i=0;i<t.length;i++)if("<"==t[i])s=!0;else if(">"==t[i])s=!1;else if("B"==t[i])r(e[a],1),a++;else if("H"==t[i])r(e[a],2),a++;else{if("I"!=t[i])throw new Error(`Unhandled character "${t[i]}" in pack format`);r(e[a],4),a++}return i},s=(t,e)=>{let a=0,i=[];for(let s of t)if("B"==s)i.push(255&e[a]),a+=1;else if("H"==s)i.push(255&e[a]|(255&e[a+1])<<8),a+=2;else{if("I"!=s)throw new Error(`Unhandled character "${s}" in unpack format`);i.push(255&e[a]|(255&e[a+1])<<8|(255&e[a+2])<<16|(255&e[a+3])<<24),a+=4}return i},r=(t,e=2)=>"0x"+t.toString(16).toUpperCase().padStart(e,"0"),n=t=>new Promise((e=>setTimeout(e,t))),h={"512KB":0,"256KB":16,"1MB":32,"2MB":48,"4MB":64,"2MB-c1":80,"4MB-c1":96,"8MB":128,"16MB":144},l={"1MB":0,"2MB":16,"4MB":32,"8MB":48,"16MB":64},o={18:"256KB",19:"512KB",20:"1MB",21:"2MB",22:"4MB",23:"8MB",24:"16MB",25:"32MB",26:"64MB"},_=a(" UUUUUUUUUUUUUUUUUUUUUUUUUUUUUUUU"),d=33382,g=50,c=12882,u={4293968129:{name:"ESP8266",family:33382},15736195:{name:"ESP32",family:g},1990:{name:"ESP32-S2",family:c},9:{name:"ESP32-S3",family:12883},3942662454:{name:"ESP32-S3(beta2)",family:12883},1763790959:{name:"ESP32-C3",family:12835},456216687:{name:"ESP32-C3",family:12835},3391540258:{name:"ESP32-H2",family:12914},228687983:{name:"ESP32-C6(beta)",family:12838}},f=(t,e)=>{let a=Math.floor(t*(e/486));return a<3e3?3e3:a},p=async t=>{let e;return t==g?e=await import("./c.1f38c020.js"):t==c?e=await import("./c.55c65bd8.js"):33382==t&&(e=await import("./c.23d34ba5.js")),{...e,text:a(atob(e.text)),data:a(atob(e.data))}};function w(t){let e=t.length;for(;--e>=0;)t[e]=0}const m=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),b=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),y=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),v=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),k=new Array(576);w(k);const z=new Array(60);w(z);const S=new Array(512);w(S);const U=new Array(256);w(U);const E=new Array(29);w(E);const I=new Array(30);function B(t,e,a,i,s){this.static_tree=t,this.extra_bits=e,this.extra_base=a,this.elems=i,this.max_length=s,this.has_stree=t&&t.length}let A,F,x;function R(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}w(I);const O=t=>t<256?S[t]:S[256+(t>>>7)],D=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},C=(t,e,a)=>{t.bi_valid>16-a?(t.bi_buf|=e<<t.bi_valid&65535,D(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=a-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=a)},L=(t,e,a)=>{C(t,a[2*e],a[2*e+1])},T=(t,e)=>{let a=0;do{a|=1&t,t>>>=1,a<<=1}while(--e>0);return a>>>1},Z=(t,e,a)=>{const i=new Array(16);let s,r,n=0;for(s=1;s<=15;s++)i[s]=n=n+a[s-1]<<1;for(r=0;r<=e;r++){let e=t[2*r+1];0!==e&&(t[2*r]=T(i[e]++,e))}},M=t=>{let e;for(e=0;e<286;e++)t.dyn_ltree[2*e]=0;for(e=0;e<30;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.last_lit=t.matches=0},P=t=>{t.bi_valid>8?D(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},N=(t,e,a,i)=>{const s=2*e,r=2*a;return t[s]<t[r]||t[s]===t[r]&&i[e]<=i[a]},$=(t,e,a)=>{const i=t.heap[a];let s=a<<1;for(;s<=t.heap_len&&(s<t.heap_len&&N(e,t.heap[s+1],t.heap[s],t.depth)&&s++,!N(e,i,t.heap[s],t.depth));)t.heap[a]=t.heap[s],a=s,s<<=1;t.heap[a]=i},H=(t,e,a)=>{let i,s,r,n,h=0;if(0!==t.last_lit)do{i=t.pending_buf[t.d_buf+2*h]<<8|t.pending_buf[t.d_buf+2*h+1],s=t.pending_buf[t.l_buf+h],h++,0===i?L(t,s,e):(r=U[s],L(t,r+256+1,e),n=m[r],0!==n&&(s-=E[r],C(t,s,n)),i--,r=O(i),L(t,r,a),n=b[r],0!==n&&(i-=I[r],C(t,i,n)))}while(h<t.last_lit);L(t,256,e)},W=(t,e)=>{const a=e.dyn_tree,i=e.stat_desc.static_tree,s=e.stat_desc.has_stree,r=e.stat_desc.elems;let n,h,l,o=-1;for(t.heap_len=0,t.heap_max=573,n=0;n<r;n++)0!==a[2*n]?(t.heap[++t.heap_len]=o=n,t.depth[n]=0):a[2*n+1]=0;for(;t.heap_len<2;)l=t.heap[++t.heap_len]=o<2?++o:0,a[2*l]=1,t.depth[l]=0,t.opt_len--,s&&(t.static_len-=i[2*l+1]);for(e.max_code=o,n=t.heap_len>>1;n>=1;n--)$(t,a,n);l=r;do{n=t.heap[1],t.heap[1]=t.heap[t.heap_len--],$(t,a,1),h=t.heap[1],t.heap[--t.heap_max]=n,t.heap[--t.heap_max]=h,a[2*l]=a[2*n]+a[2*h],t.depth[l]=(t.depth[n]>=t.depth[h]?t.depth[n]:t.depth[h])+1,a[2*n+1]=a[2*h+1]=l,t.heap[1]=l++,$(t,a,1)}while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((t,e)=>{const a=e.dyn_tree,i=e.max_code,s=e.stat_desc.static_tree,r=e.stat_desc.has_stree,n=e.stat_desc.extra_bits,h=e.stat_desc.extra_base,l=e.stat_desc.max_length;let o,_,d,g,c,u,f=0;for(g=0;g<=15;g++)t.bl_count[g]=0;for(a[2*t.heap[t.heap_max]+1]=0,o=t.heap_max+1;o<573;o++)_=t.heap[o],g=a[2*a[2*_+1]+1]+1,g>l&&(g=l,f++),a[2*_+1]=g,_>i||(t.bl_count[g]++,c=0,_>=h&&(c=n[_-h]),u=a[2*_],t.opt_len+=u*(g+c),r&&(t.static_len+=u*(s[2*_+1]+c)));if(0!==f){do{for(g=l-1;0===t.bl_count[g];)g--;t.bl_count[g]--,t.bl_count[g+1]+=2,t.bl_count[l]--,f-=2}while(f>0);for(g=l;0!==g;g--)for(_=t.bl_count[g];0!==_;)d=t.heap[--o],d>i||(a[2*d+1]!==g&&(t.opt_len+=(g-a[2*d+1])*a[2*d],a[2*d+1]=g),_--)}})(t,e),Z(a,o,t.bl_count)},j=(t,e,a)=>{let i,s,r=-1,n=e[1],h=0,l=7,o=4;for(0===n&&(l=138,o=3),e[2*(a+1)+1]=65535,i=0;i<=a;i++)s=n,n=e[2*(i+1)+1],++h<l&&s===n||(h<o?t.bl_tree[2*s]+=h:0!==s?(s!==r&&t.bl_tree[2*s]++,t.bl_tree[32]++):h<=10?t.bl_tree[34]++:t.bl_tree[36]++,h=0,r=s,0===n?(l=138,o=3):s===n?(l=6,o=3):(l=7,o=4))},K=(t,e,a)=>{let i,s,r=-1,n=e[1],h=0,l=7,o=4;for(0===n&&(l=138,o=3),i=0;i<=a;i++)if(s=n,n=e[2*(i+1)+1],!(++h<l&&s===n)){if(h<o)do{L(t,s,t.bl_tree)}while(0!=--h);else 0!==s?(s!==r&&(L(t,s,t.bl_tree),h--),L(t,16,t.bl_tree),C(t,h-3,2)):h<=10?(L(t,17,t.bl_tree),C(t,h-3,3)):(L(t,18,t.bl_tree),C(t,h-11,7));h=0,r=s,0===n?(l=138,o=3):s===n?(l=6,o=3):(l=7,o=4)}};let Y=!1;const q=(t,e,a,i)=>{C(t,0+(i?1:0),3),((t,e,a,i)=>{P(t),D(t,a),D(t,~a),t.pending_buf.set(t.window.subarray(e,e+a),t.pending),t.pending+=a})(t,e,a)};var G={_tr_init:t=>{Y||((()=>{let t,e,a,i,s;const r=new Array(16);for(a=0,i=0;i<28;i++)for(E[i]=a,t=0;t<1<<m[i];t++)U[a++]=i;for(U[a-1]=i,s=0,i=0;i<16;i++)for(I[i]=s,t=0;t<1<<b[i];t++)S[s++]=i;for(s>>=7;i<30;i++)for(I[i]=s<<7,t=0;t<1<<b[i]-7;t++)S[256+s++]=i;for(e=0;e<=15;e++)r[e]=0;for(t=0;t<=143;)k[2*t+1]=8,t++,r[8]++;for(;t<=255;)k[2*t+1]=9,t++,r[9]++;for(;t<=279;)k[2*t+1]=7,t++,r[7]++;for(;t<=287;)k[2*t+1]=8,t++,r[8]++;for(Z(k,287,r),t=0;t<30;t++)z[2*t+1]=5,z[2*t]=T(t,5);A=new B(k,m,257,286,15),F=new B(z,b,0,30,15),x=new B(new Array(0),y,0,19,7)})(),Y=!0),t.l_desc=new R(t.dyn_ltree,A),t.d_desc=new R(t.dyn_dtree,F),t.bl_desc=new R(t.bl_tree,x),t.bi_buf=0,t.bi_valid=0,M(t)},_tr_stored_block:q,_tr_flush_block:(t,e,a,i)=>{let s,r,n=0;t.level>0?(2===t.strm.data_type&&(t.strm.data_type=(t=>{let e,a=4093624447;for(e=0;e<=31;e++,a>>>=1)if(1&a&&0!==t.dyn_ltree[2*e])return 0;if(0!==t.dyn_ltree[18]||0!==t.dyn_ltree[20]||0!==t.dyn_ltree[26])return 1;for(e=32;e<256;e++)if(0!==t.dyn_ltree[2*e])return 1;return 0})(t)),W(t,t.l_desc),W(t,t.d_desc),n=(t=>{let e;for(j(t,t.dyn_ltree,t.l_desc.max_code),j(t,t.dyn_dtree,t.d_desc.max_code),W(t,t.bl_desc),e=18;e>=3&&0===t.bl_tree[2*v[e]+1];e--);return t.opt_len+=3*(e+1)+5+5+4,e})(t),s=t.opt_len+3+7>>>3,r=t.static_len+3+7>>>3,r<=s&&(s=r)):s=r=a+5,a+4<=s&&-1!==e?q(t,e,a,i):4===t.strategy||r===s?(C(t,2+(i?1:0),3),H(t,k,z)):(C(t,4+(i?1:0),3),((t,e,a,i)=>{let s;for(C(t,e-257,5),C(t,a-1,5),C(t,i-4,4),s=0;s<i;s++)C(t,t.bl_tree[2*v[s]+1],3);K(t,t.dyn_ltree,e-1),K(t,t.dyn_dtree,a-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,n+1),H(t,t.dyn_ltree,t.dyn_dtree)),M(t),i&&P(t)},_tr_tally:(t,e,a)=>(t.pending_buf[t.d_buf+2*t.last_lit]=e>>>8&255,t.pending_buf[t.d_buf+2*t.last_lit+1]=255&e,t.pending_buf[t.l_buf+t.last_lit]=255&a,t.last_lit++,0===e?t.dyn_ltree[2*a]++:(t.matches++,e--,t.dyn_ltree[2*(U[a]+256+1)]++,t.dyn_dtree[2*O(e)]++),t.last_lit===t.lit_bufsize-1),_tr_align:t=>{C(t,2,3),L(t,256,k),(t=>{16===t.bi_valid?(D(t,t.bi_buf),t.bi_buf=0,t.bi_valid=0):t.bi_valid>=8&&(t.pending_buf[t.pending++]=255&t.bi_buf,t.bi_buf>>=8,t.bi_valid-=8)})(t)}},X=(t,e,a,i)=>{let s=65535&t|0,r=t>>>16&65535|0,n=0;for(;0!==a;){n=a>2e3?2e3:a,a-=n;do{s=s+e[i++]|0,r=r+s|0}while(--n);s%=65521,r%=65521}return s|r<<16|0};const J=new Uint32Array((()=>{let t,e=[];for(var a=0;a<256;a++){t=a;for(var i=0;i<8;i++)t=1&t?3988292384^t>>>1:t>>>1;e[a]=t}return e})());var Q=(t,e,a,i)=>{const s=J,r=i+a;t^=-1;for(let a=i;a<r;a++)t=t>>>8^s[255&(t^e[a])];return-1^t},V={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},tt={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};const{_tr_init:et,_tr_stored_block:at,_tr_flush_block:it,_tr_tally:st,_tr_align:rt}=G,{Z_NO_FLUSH:nt,Z_PARTIAL_FLUSH:ht,Z_FULL_FLUSH:lt,Z_FINISH:ot,Z_BLOCK:_t,Z_OK:dt,Z_STREAM_END:gt,Z_STREAM_ERROR:ct,Z_DATA_ERROR:ut,Z_BUF_ERROR:ft,Z_DEFAULT_COMPRESSION:pt,Z_FILTERED:wt,Z_HUFFMAN_ONLY:mt,Z_RLE:bt,Z_FIXED:yt,Z_DEFAULT_STRATEGY:vt,Z_UNKNOWN:kt,Z_DEFLATED:zt}=tt,St=(t,e)=>(t.msg=V[e],e),Ut=t=>(t<<1)-(t>4?9:0),Et=t=>{let e=t.length;for(;--e>=0;)t[e]=0};let It=(t,e,a)=>(e<<t.hash_shift^a)&t.hash_mask;const Bt=t=>{const e=t.state;let a=e.pending;a>t.avail_out&&(a=t.avail_out),0!==a&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+a),t.next_out),t.next_out+=a,e.pending_out+=a,t.total_out+=a,t.avail_out-=a,e.pending-=a,0===e.pending&&(e.pending_out=0))},At=(t,e)=>{it(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,Bt(t.strm)},Ft=(t,e)=>{t.pending_buf[t.pending++]=e},xt=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},Rt=(t,e,a,i)=>{let s=t.avail_in;return s>i&&(s=i),0===s?0:(t.avail_in-=s,e.set(t.input.subarray(t.next_in,t.next_in+s),a),1===t.state.wrap?t.adler=X(t.adler,e,s,a):2===t.state.wrap&&(t.adler=Q(t.adler,e,s,a)),t.next_in+=s,t.total_in+=s,s)},Ot=(t,e)=>{let a,i,s=t.max_chain_length,r=t.strstart,n=t.prev_length,h=t.nice_match;const l=t.strstart>t.w_size-262?t.strstart-(t.w_size-262):0,o=t.window,_=t.w_mask,d=t.prev,g=t.strstart+258;let c=o[r+n-1],u=o[r+n];t.prev_length>=t.good_match&&(s>>=2),h>t.lookahead&&(h=t.lookahead);do{if(a=e,o[a+n]===u&&o[a+n-1]===c&&o[a]===o[r]&&o[++a]===o[r+1]){r+=2,a++;do{}while(o[++r]===o[++a]&&o[++r]===o[++a]&&o[++r]===o[++a]&&o[++r]===o[++a]&&o[++r]===o[++a]&&o[++r]===o[++a]&&o[++r]===o[++a]&&o[++r]===o[++a]&&r<g);if(i=258-(g-r),r=g-258,i>n){if(t.match_start=e,n=i,i>=h)break;c=o[r+n-1],u=o[r+n]}}}while((e=d[e&_])>l&&0!=--s);return n<=t.lookahead?n:t.lookahead},Dt=t=>{const e=t.w_size;let a,i,s,r,n;do{if(r=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-262)){t.window.set(t.window.subarray(e,e+e),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,i=t.hash_size,a=i;do{s=t.head[--a],t.head[a]=s>=e?s-e:0}while(--i);i=e,a=i;do{s=t.prev[--a],t.prev[a]=s>=e?s-e:0}while(--i);r+=e}if(0===t.strm.avail_in)break;if(i=Rt(t.strm,t.window,t.strstart+t.lookahead,r),t.lookahead+=i,t.lookahead+t.insert>=3)for(n=t.strstart-t.insert,t.ins_h=t.window[n],t.ins_h=It(t,t.ins_h,t.window[n+1]);t.insert&&(t.ins_h=It(t,t.ins_h,t.window[n+3-1]),t.prev[n&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=n,n++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<262&&0!==t.strm.avail_in)},Ct=(t,e)=>{let a,i;for(;;){if(t.lookahead<262){if(Dt(t),t.lookahead<262&&e===nt)return 1;if(0===t.lookahead)break}if(a=0,t.lookahead>=3&&(t.ins_h=It(t,t.ins_h,t.window[t.strstart+3-1]),a=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),0!==a&&t.strstart-a<=t.w_size-262&&(t.match_length=Ot(t,a)),t.match_length>=3)if(i=st(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do{t.strstart++,t.ins_h=It(t,t.ins_h,t.window[t.strstart+3-1]),a=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart}while(0!=--t.match_length);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=It(t,t.ins_h,t.window[t.strstart+1]);else i=st(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(i&&(At(t,!1),0===t.strm.avail_out))return 1}return t.insert=t.strstart<2?t.strstart:2,e===ot?(At(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(At(t,!1),0===t.strm.avail_out)?1:2},Lt=(t,e)=>{let a,i,s;for(;;){if(t.lookahead<262){if(Dt(t),t.lookahead<262&&e===nt)return 1;if(0===t.lookahead)break}if(a=0,t.lookahead>=3&&(t.ins_h=It(t,t.ins_h,t.window[t.strstart+3-1]),a=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,0!==a&&t.prev_length<t.max_lazy_match&&t.strstart-a<=t.w_size-262&&(t.match_length=Ot(t,a),t.match_length<=5&&(t.strategy===wt||3===t.match_length&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){s=t.strstart+t.lookahead-3,i=st(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do{++t.strstart<=s&&(t.ins_h=It(t,t.ins_h,t.window[t.strstart+3-1]),a=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart)}while(0!=--t.prev_length);if(t.match_available=0,t.match_length=2,t.strstart++,i&&(At(t,!1),0===t.strm.avail_out))return 1}else if(t.match_available){if(i=st(t,0,t.window[t.strstart-1]),i&&At(t,!1),t.strstart++,t.lookahead--,0===t.strm.avail_out)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(i=st(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===ot?(At(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(At(t,!1),0===t.strm.avail_out)?1:2};function Tt(t,e,a,i,s){this.good_length=t,this.max_lazy=e,this.nice_length=a,this.max_chain=i,this.func=s}const Zt=[new Tt(0,0,0,0,((t,e)=>{let a=65535;for(a>t.pending_buf_size-5&&(a=t.pending_buf_size-5);;){if(t.lookahead<=1){if(Dt(t),0===t.lookahead&&e===nt)return 1;if(0===t.lookahead)break}t.strstart+=t.lookahead,t.lookahead=0;const i=t.block_start+a;if((0===t.strstart||t.strstart>=i)&&(t.lookahead=t.strstart-i,t.strstart=i,At(t,!1),0===t.strm.avail_out))return 1;if(t.strstart-t.block_start>=t.w_size-262&&(At(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===ot?(At(t,!0),0===t.strm.avail_out?3:4):(t.strstart>t.block_start&&(At(t,!1),t.strm.avail_out),1)})),new Tt(4,4,8,4,Ct),new Tt(4,5,16,8,Ct),new Tt(4,6,32,32,Ct),new Tt(4,4,16,16,Lt),new Tt(8,16,32,32,Lt),new Tt(8,16,128,128,Lt),new Tt(8,32,128,256,Lt),new Tt(32,128,258,1024,Lt),new Tt(32,258,258,4096,Lt)];function Mt(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=zt,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(1146),this.dyn_dtree=new Uint16Array(122),this.bl_tree=new Uint16Array(78),Et(this.dyn_ltree),Et(this.dyn_dtree),Et(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(16),this.heap=new Uint16Array(573),Et(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(573),Et(this.depth),this.l_buf=0,this.lit_bufsize=0,this.last_lit=0,this.d_buf=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}const Pt=t=>{if(!t||!t.state)return St(t,ct);t.total_in=t.total_out=0,t.data_type=kt;const e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap?42:113,t.adler=2===e.wrap?0:1,e.last_flush=nt,et(e),dt},Nt=t=>{const e=Pt(t);var a;return e===dt&&((a=t.state).window_size=2*a.w_size,Et(a.head),a.max_lazy_match=Zt[a.level].max_lazy,a.good_match=Zt[a.level].good_length,a.nice_match=Zt[a.level].nice_length,a.max_chain_length=Zt[a.level].max_chain,a.strstart=0,a.block_start=0,a.lookahead=0,a.insert=0,a.match_length=a.prev_length=2,a.match_available=0,a.ins_h=0),e},$t=(t,e,a,i,s,r)=>{if(!t)return ct;let n=1;if(e===pt&&(e=6),i<0?(n=0,i=-i):i>15&&(n=2,i-=16),s<1||s>9||a!==zt||i<8||i>15||e<0||e>9||r<0||r>yt)return St(t,ct);8===i&&(i=9);const h=new Mt;return t.state=h,h.strm=t,h.wrap=n,h.gzhead=null,h.w_bits=i,h.w_size=1<<h.w_bits,h.w_mask=h.w_size-1,h.hash_bits=s+7,h.hash_size=1<<h.hash_bits,h.hash_mask=h.hash_size-1,h.hash_shift=~~((h.hash_bits+3-1)/3),h.window=new Uint8Array(2*h.w_size),h.head=new Uint16Array(h.hash_size),h.prev=new Uint16Array(h.w_size),h.lit_bufsize=1<<s+6,h.pending_buf_size=4*h.lit_bufsize,h.pending_buf=new Uint8Array(h.pending_buf_size),h.d_buf=1*h.lit_bufsize,h.l_buf=3*h.lit_bufsize,h.level=e,h.strategy=r,h.method=a,Nt(t)};var Ht=$t,Wt=(t,e)=>t&&t.state?2!==t.state.wrap?ct:(t.state.gzhead=e,dt):ct,jt=(t,e)=>{let a,i;if(!t||!t.state||e>_t||e<0)return t?St(t,ct):ct;const s=t.state;if(!t.output||!t.input&&0!==t.avail_in||666===s.status&&e!==ot)return St(t,0===t.avail_out?ft:ct);s.strm=t;const r=s.last_flush;if(s.last_flush=e,42===s.status)if(2===s.wrap)t.adler=0,Ft(s,31),Ft(s,139),Ft(s,8),s.gzhead?(Ft(s,(s.gzhead.text?1:0)+(s.gzhead.hcrc?2:0)+(s.gzhead.extra?4:0)+(s.gzhead.name?8:0)+(s.gzhead.comment?16:0)),Ft(s,255&s.gzhead.time),Ft(s,s.gzhead.time>>8&255),Ft(s,s.gzhead.time>>16&255),Ft(s,s.gzhead.time>>24&255),Ft(s,9===s.level?2:s.strategy>=mt||s.level<2?4:0),Ft(s,255&s.gzhead.os),s.gzhead.extra&&s.gzhead.extra.length&&(Ft(s,255&s.gzhead.extra.length),Ft(s,s.gzhead.extra.length>>8&255)),s.gzhead.hcrc&&(t.adler=Q(t.adler,s.pending_buf,s.pending,0)),s.gzindex=0,s.status=69):(Ft(s,0),Ft(s,0),Ft(s,0),Ft(s,0),Ft(s,0),Ft(s,9===s.level?2:s.strategy>=mt||s.level<2?4:0),Ft(s,3),s.status=113);else{let e=zt+(s.w_bits-8<<4)<<8,a=-1;a=s.strategy>=mt||s.level<2?0:s.level<6?1:6===s.level?2:3,e|=a<<6,0!==s.strstart&&(e|=32),e+=31-e%31,s.status=113,xt(s,e),0!==s.strstart&&(xt(s,t.adler>>>16),xt(s,65535&t.adler)),t.adler=1}if(69===s.status)if(s.gzhead.extra){for(a=s.pending;s.gzindex<(65535&s.gzhead.extra.length)&&(s.pending!==s.pending_buf_size||(s.gzhead.hcrc&&s.pending>a&&(t.adler=Q(t.adler,s.pending_buf,s.pending-a,a)),Bt(t),a=s.pending,s.pending!==s.pending_buf_size));)Ft(s,255&s.gzhead.extra[s.gzindex]),s.gzindex++;s.gzhead.hcrc&&s.pending>a&&(t.adler=Q(t.adler,s.pending_buf,s.pending-a,a)),s.gzindex===s.gzhead.extra.length&&(s.gzindex=0,s.status=73)}else s.status=73;if(73===s.status)if(s.gzhead.name){a=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>a&&(t.adler=Q(t.adler,s.pending_buf,s.pending-a,a)),Bt(t),a=s.pending,s.pending===s.pending_buf_size)){i=1;break}i=s.gzindex<s.gzhead.name.length?255&s.gzhead.name.charCodeAt(s.gzindex++):0,Ft(s,i)}while(0!==i);s.gzhead.hcrc&&s.pending>a&&(t.adler=Q(t.adler,s.pending_buf,s.pending-a,a)),0===i&&(s.gzindex=0,s.status=91)}else s.status=91;if(91===s.status)if(s.gzhead.comment){a=s.pending;do{if(s.pending===s.pending_buf_size&&(s.gzhead.hcrc&&s.pending>a&&(t.adler=Q(t.adler,s.pending_buf,s.pending-a,a)),Bt(t),a=s.pending,s.pending===s.pending_buf_size)){i=1;break}i=s.gzindex<s.gzhead.comment.length?255&s.gzhead.comment.charCodeAt(s.gzindex++):0,Ft(s,i)}while(0!==i);s.gzhead.hcrc&&s.pending>a&&(t.adler=Q(t.adler,s.pending_buf,s.pending-a,a)),0===i&&(s.status=103)}else s.status=103;if(103===s.status&&(s.gzhead.hcrc?(s.pending+2>s.pending_buf_size&&Bt(t),s.pending+2<=s.pending_buf_size&&(Ft(s,255&t.adler),Ft(s,t.adler>>8&255),t.adler=0,s.status=113)):s.status=113),0!==s.pending){if(Bt(t),0===t.avail_out)return s.last_flush=-1,dt}else if(0===t.avail_in&&Ut(e)<=Ut(r)&&e!==ot)return St(t,ft);if(666===s.status&&0!==t.avail_in)return St(t,ft);if(0!==t.avail_in||0!==s.lookahead||e!==nt&&666!==s.status){let a=s.strategy===mt?((t,e)=>{let a;for(;;){if(0===t.lookahead&&(Dt(t),0===t.lookahead)){if(e===nt)return 1;break}if(t.match_length=0,a=st(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++,a&&(At(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===ot?(At(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(At(t,!1),0===t.strm.avail_out)?1:2})(s,e):s.strategy===bt?((t,e)=>{let a,i,s,r;const n=t.window;for(;;){if(t.lookahead<=258){if(Dt(t),t.lookahead<=258&&e===nt)return 1;if(0===t.lookahead)break}if(t.match_length=0,t.lookahead>=3&&t.strstart>0&&(s=t.strstart-1,i=n[s],i===n[++s]&&i===n[++s]&&i===n[++s])){r=t.strstart+258;do{}while(i===n[++s]&&i===n[++s]&&i===n[++s]&&i===n[++s]&&i===n[++s]&&i===n[++s]&&i===n[++s]&&i===n[++s]&&s<r);t.match_length=258-(r-s),t.match_length>t.lookahead&&(t.match_length=t.lookahead)}if(t.match_length>=3?(a=st(t,1,t.match_length-3),t.lookahead-=t.match_length,t.strstart+=t.match_length,t.match_length=0):(a=st(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++),a&&(At(t,!1),0===t.strm.avail_out))return 1}return t.insert=0,e===ot?(At(t,!0),0===t.strm.avail_out?3:4):t.last_lit&&(At(t,!1),0===t.strm.avail_out)?1:2})(s,e):Zt[s.level].func(s,e);if(3!==a&&4!==a||(s.status=666),1===a||3===a)return 0===t.avail_out&&(s.last_flush=-1),dt;if(2===a&&(e===ht?rt(s):e!==_t&&(at(s,0,0,!1),e===lt&&(Et(s.head),0===s.lookahead&&(s.strstart=0,s.block_start=0,s.insert=0))),Bt(t),0===t.avail_out))return s.last_flush=-1,dt}return e!==ot?dt:s.wrap<=0?gt:(2===s.wrap?(Ft(s,255&t.adler),Ft(s,t.adler>>8&255),Ft(s,t.adler>>16&255),Ft(s,t.adler>>24&255),Ft(s,255&t.total_in),Ft(s,t.total_in>>8&255),Ft(s,t.total_in>>16&255),Ft(s,t.total_in>>24&255)):(xt(s,t.adler>>>16),xt(s,65535&t.adler)),Bt(t),s.wrap>0&&(s.wrap=-s.wrap),0!==s.pending?dt:gt)},Kt=t=>{if(!t||!t.state)return ct;const e=t.state.status;return 42!==e&&69!==e&&73!==e&&91!==e&&103!==e&&113!==e&&666!==e?St(t,ct):(t.state=null,113===e?St(t,ut):dt)},Yt=(t,e)=>{let a=e.length;if(!t||!t.state)return ct;const i=t.state,s=i.wrap;if(2===s||1===s&&42!==i.status||i.lookahead)return ct;if(1===s&&(t.adler=X(t.adler,e,a,0)),i.wrap=0,a>=i.w_size){0===s&&(Et(i.head),i.strstart=0,i.block_start=0,i.insert=0);let t=new Uint8Array(i.w_size);t.set(e.subarray(a-i.w_size,a),0),e=t,a=i.w_size}const r=t.avail_in,n=t.next_in,h=t.input;for(t.avail_in=a,t.next_in=0,t.input=e,Dt(i);i.lookahead>=3;){let t=i.strstart,e=i.lookahead-2;do{i.ins_h=It(i,i.ins_h,i.window[t+3-1]),i.prev[t&i.w_mask]=i.head[i.ins_h],i.head[i.ins_h]=t,t++}while(--e);i.strstart=t,i.lookahead=2,Dt(i)}return i.strstart+=i.lookahead,i.block_start=i.strstart,i.insert=i.lookahead,i.lookahead=0,i.match_length=i.prev_length=2,i.match_available=0,t.next_in=n,t.input=h,t.avail_in=r,i.wrap=s,dt};const qt=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);try{String.fromCharCode.apply(null,new Uint8Array(1))}catch(e){}const Gt=new Uint8Array(256);for(let t=0;t<256;t++)Gt[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;Gt[254]=Gt[254]=1;var Xt=t=>{let e,a,i,s,r,n=t.length,h=0;for(s=0;s<n;s++)a=t.charCodeAt(s),55296==(64512&a)&&s+1<n&&(i=t.charCodeAt(s+1),56320==(64512&i)&&(a=65536+(a-55296<<10)+(i-56320),s++)),h+=a<128?1:a<2048?2:a<65536?3:4;for(e=new Uint8Array(h),r=0,s=0;r<h;s++)a=t.charCodeAt(s),55296==(64512&a)&&s+1<n&&(i=t.charCodeAt(s+1),56320==(64512&i)&&(a=65536+(a-55296<<10)+(i-56320),s++)),a<128?e[r++]=a:a<2048?(e[r++]=192|a>>>6,e[r++]=128|63&a):a<65536?(e[r++]=224|a>>>12,e[r++]=128|a>>>6&63,e[r++]=128|63&a):(e[r++]=240|a>>>18,e[r++]=128|a>>>12&63,e[r++]=128|a>>>6&63,e[r++]=128|63&a);return e},Jt=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};const Qt=Object.prototype.toString,{Z_NO_FLUSH:Vt,Z_SYNC_FLUSH:te,Z_FULL_FLUSH:ee,Z_FINISH:ae,Z_OK:ie,Z_STREAM_END:se,Z_DEFAULT_COMPRESSION:re,Z_DEFAULT_STRATEGY:ne,Z_DEFLATED:he}=tt;function le(t){this.options=function(t){const e=Array.prototype.slice.call(arguments,1);for(;e.length;){const a=e.shift();if(a){if("object"!=typeof a)throw new TypeError(a+"must be non-object");for(const e in a)qt(a,e)&&(t[e]=a[e])}}return t}({level:re,method:he,chunkSize:16384,windowBits:15,memLevel:8,strategy:ne},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new Jt,this.strm.avail_out=0;let a=Ht(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(a!==ie)throw new Error(V[a]);if(e.header&&Wt(this.strm,e.header),e.dictionary){let t;if(t="string"==typeof e.dictionary?Xt(e.dictionary):"[object ArrayBuffer]"===Qt.call(e.dictionary)?new Uint8Array(e.dictionary):e.dictionary,a=Yt(this.strm,t),a!==ie)throw new Error(V[a]);this._dict_set=!0}}function oe(t,e){const a=new le(e);if(a.push(t,!0),a.err)throw a.msg||V[a.err];return a.result}le.prototype.push=function(t,e){const a=this.strm,i=this.options.chunkSize;let s,r;if(this.ended)return!1;for(r=e===~~e?e:!0===e?ae:Vt,"string"==typeof t?a.input=Xt(t):"[object ArrayBuffer]"===Qt.call(t)?a.input=new Uint8Array(t):a.input=t,a.next_in=0,a.avail_in=a.input.length;;)if(0===a.avail_out&&(a.output=new Uint8Array(i),a.next_out=0,a.avail_out=i),(r===te||r===ee)&&a.avail_out<=6)this.onData(a.output.subarray(0,a.next_out)),a.avail_out=0;else{if(s=jt(a,r),s===se)return a.next_out>0&&this.onData(a.output.subarray(0,a.next_out)),s=Kt(this.strm),this.onEnd(s),this.ended=!0,s===ie;if(0!==a.avail_out){if(r>0&&a.next_out>0)this.onData(a.output.subarray(0,a.next_out)),a.avail_out=0;else if(0===a.avail_in)break}else this.onData(a.output)}return!0},le.prototype.onData=function(t){this.chunks.push(t)},le.prototype.onEnd=function(t){t===ie&&(this.result=(t=>{let e=0;for(let a=0,i=t.length;a<i;a++)e+=t[a].length;const a=new Uint8Array(e);for(let e=0,i=0,s=t.length;e<s;e++){let s=t[e];a.set(s,i),i+=s.length}return a})(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var _e={Deflate:le,deflate:oe,deflateRaw:function(t,e){return(e=e||{}).raw=!0,oe(t,e)},gzip:function(t,e){return(e=e||{}).gzip=!0,oe(t,e)},constants:tt};const{Deflate:de,deflate:ge,deflateRaw:ce,gzip:ue}=_e;var fe=ge;class pe extends EventTarget{constructor(t,e,a){super(),this.port=t,this.logger=e,this._parent=a,this.chipName=null,this._efuses=new Array(4).fill(0),this._flashsize=4194304,this.debug=!1,this.IS_STUB=!1,this.connected=!0,this.stopReadLoop=!1,this.flashSize=null}get _inputBuffer(){return this._parent?this._parent._inputBuffer:this.__inputBuffer}async initialize(){await this.hardReset(!0),this._parent||(this.__inputBuffer=[],this.readLoop()),await this.sync();let t,e=await this.readRegister(1073745920),a=u[e];if(void 0===a)throw new Error("Unknown Chip.");this.chipName=a.name,this.chipFamily=a.family,33382==this.chipFamily?t=1072693328:(this.chipFamily==g||this.chipFamily==c)&&(t=1610719232);for(let e=0;e<4;e++)this._efuses[e]=await this.readRegister(t+4*e);this.logger.log(`Chip type ${this.chipName}`)}async readLoop(){this.logger.debug("Starting read loop"),this._reader=this.port.readable.getReader();try{for(;!this.stopReadLoop;){const{value:t,done:e}=await this._reader.read();if(e){this._reader.releaseLock();break}t&&0!==t.length&&this._inputBuffer.push(...Array.from(t))}}catch(t){console.error("Read loop got disconnected"),this.connected=!1,this.dispatchEvent(new Event("disconnect"))}this.logger.debug("Finished read loop")}async hardReset(t=!1){this.logger.log("Try hard reset."),await this.port.setSignals({dataTerminalReady:!1,requestToSend:!0}),await this.port.setSignals({dataTerminalReady:t,requestToSend:!1}),await new Promise((t=>setTimeout(t,1e3)))}macAddr(){let t,e=new Array(6).fill(0),a=this._efuses[0],i=this._efuses[1],s=this._efuses[2],r=this._efuses[3];if(33382==this.chipFamily){if(0!=r)t=[r>>16&255,r>>8&255,255&r];else if(0==(i>>16&255))t=[24,254,52];else{if(1!=(i>>16&255))throw new Error("Couldnt determine OUI");t=[172,208,116]}e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=i>>8&255,e[4]=255&i,e[5]=a>>24&255}else if(this.chipFamily==g)e[0]=s>>8&255,e[1]=255&s,e[2]=i>>24&255,e[3]=i>>16&255,e[4]=i>>8&255,e[5]=255&i;else{if(this.chipFamily!=c)throw new Error("Unknown chip family");e[0]=s>>8&255,e[1]=255&s,e[2]=i>>24&255,e[3]=i>>16&255,e[4]=i>>8&255,e[5]=255&i}return e}async readRegister(t){this.debug&&this.logger.debug("Reading Register",t);let e=i("I",t),a=(await this.checkCommand(10,e))[0];return s("I",a)[0]}async checkCommand(t,e,a=0,i=3e3){i=Math.min(i,12e5),await this.sendCommand(t,e,a);let[s,n]=await this.getResponse(t,i);if(null===n)throw new Error("Didn't get enough status bytes");let h=0;if(this.IS_STUB||33382==this.chipFamily?h=2:[g,c].includes(this.chipFamily)?h=4:[2,4].includes(n.length)&&(h=n.length),n.length<h)throw new Error("Didn't get enough status bytes");let l=n.slice(-h,n.length);if(n=n.slice(0,-h),this.debug&&(this.logger.debug("status",l),this.logger.debug("value",s),this.logger.debug("data",n)),1==l[0])throw 5==l[1]?new Error("Invalid (unsupported) command "+r(t)):new Error("Command failure error code "+r(l[1]));return[s,n]}async sendCommand(t,a,s=0){this._inputBuffer.length=0;let r=[192,0];r.push(t),r=r.concat(i("H",a.length)),r=r.concat(e(i("I",s))),r=r.concat(e(a)),r.push(192),this.debug&&this.logger.debug("Writing "+r.length+" byte"+(1==r.length?"":"s")+":",r),await this.writeToStream(r)}async getResponse(t,e=3e3){let a=[],i=0,s=!1,r=Date.now();for(;Date.now()-r<e;){if(this._inputBuffer.length>0){let t=this._inputBuffer.shift();219==t?s=!0:s?(221==t?a.push(220):220==t?a.push(192):a=a.concat([219,t]),s=!1):a.push(t)}else await n(10);if(a.length>0&&192!=a[0]&&a.shift(),a.length>1&&1!=a[1]&&a.shift(),a.length>2&&a[2]!=t&&a.shift(),a.length>4&&(i=a[3]+(a[4]<<8)),a.length==i+10)break}if(a.length!=i+10)return this.logger.log("Timed out after "+e+" milliseconds"),[null,null];this.debug&&this.logger.debug("Reading "+a.length+" byte"+(1==a.length?"":"s")+":",a);let h=a.slice(5,9),l=a.slice(9,-1);return this.debug&&this.logger.debug("value:",h,"data:",l),[h,l]}async readBuffer(t=3e3){let e=[],a=!1,i=Date.now();for(;Date.now()-i<t;){if(this._inputBuffer.length>0){let t=this._inputBuffer.shift();219==t?a=!0:a?(221==t?e.push(220):220==t?e.push(192):e=e.concat([219,t]),a=!1):e.push(t)}else await n(10);if(e.length>0&&192!=e[0]&&e.shift(),e.length>1&&192==e[e.length-1])break}if(e.length<2)return this.logger.log("Timed out after "+t+" milliseconds"),null;this.debug&&this.logger.debug("Reading "+e.length+" byte"+(1==e.length?"":"s")+":",e);let s=e.slice(1,-1);return this.debug&&this.logger.debug("data:",s),s}checksum(t,e=239){for(let a of t)e^=a;return e}async setBaudrate(t){if(33382==this.chipFamily)throw new Error("Changing baud rate is not supported on the ESP8266");this.logger.log("Attempting to change baud rate to "+t+"...");try{let e=i("<II",t,this.IS_STUB?115200:0);await this.checkCommand(15,e)}catch(e){throw console.error(e),new Error(`Unable to change the baud rate to ${t}: No response from set baud rate command.`)}this._parent?await this._parent.reconfigurePort(t):await this.reconfigurePort(t)}async reconfigurePort(t){var e,a;try{this.stopReadLoop=!0,await(null===(e=this._reader)||void 0===e?void 0:e.cancel()),null===(a=this._reader)||void 0===a||a.releaseLock(),await this.port.close(),await this.port.open({baudRate:t}),this.stopReadLoop=!1,this.readLoop(),this.logger.log(`Changed baud rate to ${t}`)}catch(e){throw console.error(e),new Error(`Unable to change the baud rate to ${t}: ${e}`)}}async sync(){for(let t=0;t<5;t++){if(await this._sync())return await n(100),!0;await n(100)}throw new Error("Couldn't sync to ESP. Try resetting.")}async _sync(){await this.sendCommand(8,_);for(let t=0;t<8;t++){let[t,e]=await this.getResponse(8,100);if(null!==e&&e.length>1&&0==e[0]&&0==e[1])return!0}return!1}getFlashWriteSize(){return this.IS_STUB?16384:1024}async flashData(t,e,a=0,i=!1){this.updateImageFlashParams(a,t);let s,n=t.byteLength,h=0;i?(s=fe(new Uint8Array(t),{level:9}).buffer,h=s.byteLength,this.logger.log(`Writing data with filesize: ${n}. Compressed Size: ${h}`),await this.flashDeflBegin(n,h,a)):(this.logger.log(`Writing data with filesize: ${n}`),s=t,await this.flashBegin(n,a));let l=[],o=0,_=0,d=0,g=Date.now(),c=this.getFlashWriteSize(),u=i?h:n;for(;u-d>0;)this.debug&&this.logger.log(`Writing at ${r(a+o*c,8)} `),u-d>=c?l=Array.from(new Uint8Array(s,d,c)):(l=Array.from(new Uint8Array(s,d,u-d)),i||(l=l.concat(new Array(c-l.length).fill(255)))),i?await this.flashDeflBlock(l,o,2e3):await this.flashBlock(l,o,2e3),o+=1,_+=i?Math.round(l.length*n/h):l.length,d+=c,e(_,u);this.logger.log("Took "+(Date.now()-g)+"ms to write "+u+" bytes"),this.IS_STUB&&(await this.flashBegin(0,0),i?await this.flashDeflFinish():await this.flashFinish())}async flashBlock(t,e,a=100){await this.checkCommand(3,i("<IIII",t.length,e,0,0).concat(t),this.checksum(t),a)}async flashDeflBlock(t,e,a=100){await this.checkCommand(17,i("<IIII",t.length,e,0,0).concat(t),this.checksum(t))}async flashBegin(t=0,e=0,a=!1){let s,n,h=this.getFlashWriteSize();[g,c].includes(this.chipFamily)&&await this.checkCommand(13,new Array(8).fill(0)),this.chipFamily==g&&(n=i("<IIIIII",0,this._flashsize,65536,4096,256,65535),await this.checkCommand(11,n));let l,o=Math.floor((t+h-1)/h);s=33382==this.chipFamily?this.getEraseSize(e,t):t,l=this.IS_STUB?3e3:f(3e4,t);let _=Date.now();return n=i("<IIII",s,o,h,e),this.chipFamily==c&&(n=n.concat(i("<I",a?1:0))),this.logger.log("Erase size "+s+", blocks "+o+", block size "+h+", offset "+r(e,4)+", encrypted "+(a?"yes":"no")),await this.checkCommand(2,n,0,l),0==t||this.IS_STUB||this.logger.log("Took "+(Date.now()-_)+"ms to erase "+o+" bytes"),o}async flashDeflBegin(t=0,e=0,a=0,s=!1){let r,n=this.getFlashWriteSize(),h=Math.floor((e+n-1)/n),l=Math.floor((t+n-1)/n),o=0,_=0;return this.IS_STUB?(o=t,_=3e3):(o=l*n,_=f(3e4,o)),r=i("<IIII",o,h,n,a),await this.checkCommand(16,r,0,_),h}async flashFinish(){let t=i("<I",1);await this.checkCommand(4,t)}async flashDeflFinish(){let t=i("<I",1);await this.checkCommand(18,t)}getBootloaderOffset(){var t;return this.chipFamily==g||(null===(t=this._parent)||void 0===t?void 0:t.chipFamily)==g?4096:0}updateImageFlashParams(t,e){if(e.byteLength<8)return e;var a=Array.from(new Uint8Array(e,0,4));let s=a[0],n=a[2],h=a[3];if(this.logger.debug(`Image header, Magic=${r(s)}, FlashMode=${r(n)}, FlashSizeFreq=${r(h)}`),t!=this.getBootloaderOffset())return e;if(233!=s)return this.logger.log("Warning: Image file at %s doesn't look like an image file, so not changing any flash settings.",r(t,4)),e;this.logger.log("Image being flashed is a bootloader");let l=this.getFlashSizes()[this.flashSize?this.flashSize:"4MB"],o=i("BB",2,l+0),_=new Uint8Array(e,2,2);return o[0]!=_[0]||o[1]!=_[1]?(_[0]=o[0],_[1]=o[1],this.logger.log(`Patching Flash parameters header bytes to ${r(o[0],2)} ${r(o[1],2)}`)):this.logger.log("Flash parameters header did not need patching."),e}getFlashSizes(){return this.getChipFamily()==g?l:h}async flashId(){return await this.runSpiFlashCommand(159,[],24)}getChipFamily(){return this._parent?this._parent.chipFamily:this.chipFamily}async writeRegister(t,e,a=4294967295,s=0,r=0){let n=i("<IIII",t,e,a,s);r>0&&n.concat(i("<IIII",(t=>{switch(this.getChipFamily()){case g:case c:case 33382:return 1610612856;default:return-1}})(),0,0,r)),await this.checkCommand(9,n)}async setDataLengths(t,e,a){if(-1!=t.mosiDlenOffs){let i=t.regBase+t.mosiDlenOffs,s=t.regBase+t.misoDlenOffs;e>0&&await this.writeRegister(i,e-1),a>0&&await this.writeRegister(s,a-1)}else{let i=t.regBase+t.usr1Offs,s=(0==a?0:a-1)<<8|(0==e?0:e-1)<<17;await this.writeRegister(i,s)}}async waitDone(t,e){for(let a=0;a<10;a++)if(0==(await this.readRegister(t)&e))return;throw Error("SPI command did not complete in time")}async runSpiFlashCommand(t,e,a=0){let i=(t=>{switch(this.getChipFamily()){case g:case c:return{regBase:1072963584,usrOffs:28,usr1Offs:32,usr2Offs:36,mosiDlenOffs:40,misoDlenOffs:44,w0Offs:128};case 33382:return{regBase:1610613248,usrOffs:28,usr1Offs:32,usr2Offs:36,mosiDlenOffs:-1,misoDlenOffs:-1,w0Offs:64};default:return{regBase:-1,usrOffs:-1,usr1Offs:-1,usr2Offs:-1,mosiDlenOffs:-1,misoDlenOffs:-1,w0Offs:-1}}})(),n=i.regBase,h=n+0,l=n+i.usrOffs,o=n+i.usr2Offs,_=n+i.w0Offs,d=1<<18;if(a>32)throw new Error("Reading more than 32 bits back from a SPI flash operation is unsupported");if(e.length>64)throw new Error("Writing more than 64 bytes of data with one SPI command is unsupported");let u=8*e.length,f=await this.readRegister(l),p=await this.readRegister(o),w=1<<31;if(a>0&&(w|=268435456),u>0&&(w|=134217728),await this.setDataLengths(i,u,a),await this.writeRegister(l,w),await this.writeRegister(o,7<<28|t),0==u)await this.writeRegister(_,0);else{e.concat(new Array(e.length%4).fill(0));let t=s("I".repeat(Math.floor(e.length/4)),e),a=_;this.logger.debug(`Words Length: ${t.length}`);for(const e of t)this.logger.debug(`Writing word ${r(e)} to register offset ${r(a)}`),await this.writeRegister(a,e),a+=4}await this.writeRegister(h,d),await this.waitDone(h,d);let m=await this.readRegister(_);return await this.writeRegister(l,f),await this.writeRegister(o,p),m}async detectFlashSize(){this.logger.log("Detecting Flash Size");let t=await this.flashId(),e=255&t,a=t>>16&255;this.logger.debug(`FlashId: ${r(t)}`),this.logger.log(`Flash Manufacturer: ${e.toString(16)}`),this.logger.log(`Flash Device: ${(t>>8&255).toString(16)}${a.toString(16)}`),this.flashSize=o[a],this.logger.log(`Auto-detected Flash size: ${this.flashSize}`)}getEraseSize(t,e){let a=4096,i=Math.floor((e+a-1)/a),s=16-Math.floor(t/a)%16;return i<s&&(s=i),i<2*s?Math.floor((i+1)/2*a):(i-s)*a}async memBegin(t,e,a,s){return await this.checkCommand(5,i("<IIII",t,e,a,s))}async memBlock(t,e){return await this.checkCommand(7,i("<IIII",t.length,e,0,0).concat(t),this.checksum(t))}async memFinish(t=0){let e=this.IS_STUB?3e3:50,a=i("<II",0==t?1:0,t);return await this.checkCommand(6,a,0,e)}async runStub(){const t=await p(this.chipFamily);let e=2048;this.logger.log("Uploading stub...");for(let a of["text","data"])if(Object.keys(t).includes(a)){let i=t[a+"_start"],s=t[a].length,r=Math.floor((s+e-1)/e);await this.memBegin(s,r,e,i);for(let i of Array(r).keys()){let r=i*e,n=r+e;n>s&&(n=s),await this.memBlock(t[a].slice(r,n),i)}}this.logger.log("Running stub..."),await this.memFinish(t.entry);const a=await this.readBuffer(100),i=String.fromCharCode(...a);if("OHAI"!=i)throw new Error("Failed to start stub. Unexpected response: "+i);this.logger.log("Stub is now running...");const s=new we(this.port,this.logger,this);return await s.detectFlashSize(),s}async writeToStream(t){const e=this.port.writable.getWriter();await e.write(new Uint8Array(t));try{e.releaseLock()}catch(t){console.error("Ignoring release lock error",t)}}async disconnect(){this._parent?await this._parent.disconnect():(this._reader&&await this._reader.cancel(),await this.port.writable.getWriter().close(),await this.port.close(),this.connected=!1)}}class we extends pe{constructor(){super(...arguments),this.IS_STUB=!0}async memBegin(t,e,a,i){let s=await p(this.chipFamily),n=i,h=i+t;console.log(n,h),console.log(s.data_start,s.data.length,s.text_start,s.text.length);for(let[t,e]of[[s.data_start,s.data_start+s.data.length],[s.text_start,s.text_start+s.text.length]])if(n<e&&h>t)throw new Error("Software loader is resident at "+r(t,8)+"-"+r(e,8)+". Can't load binary at overlapping address range "+r(n,8)+"-"+r(h,8)+". Try changing the binary loading address.")}async eraseFlash(){await this.checkCommand(208,[],0,6e5)}}const me=async t=>{const e=await navigator.serial.requestPort();return t.log("Connecting..."),await e.open({baudRate:115200}),t.log("Connected successfully."),new pe(e,t)},be="serial"in navigator,ye="https:"===location.protocol||"localhost"===location.hostname,ve={[g]:"ESP32",33382:"ESP8266"},ke=t`
  <svg width="24" height="24" viewBox="0 0 24 24" slot="meta">
    <path d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" />
  </svg>
`;export{ye as a,g as b,ve as c,d as f,ke as m,me as n,be as s};
