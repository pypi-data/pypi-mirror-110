$(document).ready((function(){M.AutoInit(document.body),n(),k(),a()}));const e=window.location,t=new URL("./",`${e.protocol}//${e.host}${e.pathname}`);t.protocol="ws:","https:"===e.protocol&&(t.protocol="wss:");const o=t.href,a=()=>{const e=()=>{const e=$(".select-wrapper");$(".navbar-fixed").css("height",e.position().top+e.outerHeight()+"px")};$(window).resize(e),e()},n=()=>{const e=document.querySelectorAll("#nodes .card").length,t=document.querySelector("#nodes #grid");e<=3?t.classList.add("grid-1-col"):e<=6?t.classList.add("grid-2-col"):t.classList.add("grid-3-col")},s=document.querySelector(".nav-wrapper select");let l=[];const i=(e=!1)=>{fetch("./serial-ports",{credentials:"same-origin"}).then((e=>e.json())).then((t=>{if(l.length===t.length){let e=!0;for(let o=0;o<t.length;o++)if(l[o].port!==t[o].port){e=!1;break}if(e)return}const o=t.length>=l.length;l=t;const a=M.FormSelect.getInstance(s);void 0!==a&&a.destroy(),s.innerHTML="";const n=d();for(let e=0;e<t.length;e++){const o=t[e];o.port===n?s.innerHTML+=`<option value="${o.port}" selected>${o.port} (${o.desc})</option>`:s.innerHTML+=`<option value="${o.port}">${o.port} (${o.desc})</option>`}M.FormSelect.init(s,{}),!e&&o&&M.toast({html:"Discovered new serial port."})}))},d=()=>{const e=M.FormSelect.getInstance(s);return void 0===e?"OTA":(e._setSelectedStates(),e.getSelectedValues()[0])};setInterval(i,5e3),i(!0);class r{constructor({name:e,onPrepare:t=((e,t)=>{}),onProcessExit:a=((e,t)=>{}),onSocketClose:n=(e=>{}),dismissible:s=!0}){this.modalId=`js-${e}-modal`,this.dataAction=`${e}`,this.wsUrl=`${o}${e}`,this.dismissible=s,this.activeFilename=null,this.modalElement=document.getElementById(this.modalId),this.nodeFilenameElement=document.querySelector(`#${this.modalId} #js-node-filename`),this.logElement=document.querySelector(`#${this.modalId} #js-log-area`),this.onPrepare=t,this.onProcessExit=a,this.onSocketClose=n}setup(){const e=this._onPress.bind(this);document.querySelectorAll(`[data-action="${this.dataAction}"]`).forEach((t=>{t.addEventListener("click",e)}))}_setupModalInstance(){this.modalInstance=M.Modal.init(this.modalElement,{onOpenStart:this._onOpenStart.bind(this),onCloseStart:this._onCloseStart.bind(this),dismissible:this.dismissible})}_onOpenStart(){document.addEventListener("keydown",this._boundKeydown)}_onCloseStart(){document.removeEventListener("keydown",this._boundKeydown),this.activeSocket.close()}open(e){this._onPress(e)}_onPress(e){this.activeFilename=e.target.dataset.filename,this._setupModalInstance(),this.nodeFilenameElement.innerHTML=this.activeFilename,this.logElement.innerHTML="";const t={bold:!1,italic:!1,underline:!1,strikethrough:!1,foregroundColor:!1,backgroundColor:!1,carriageReturn:!1,secret:!1};this.onPrepare(this.modalElement,this.activeFilename);let o=!1;this.modalInstance.open();const a=new WebSocket(this.wsUrl);this.activeSocket=a,a.addEventListener("message",(e=>{const a=JSON.parse(e.data);"line"===a.event?((e,t,o)=>{const a=/(?:\033|\\033)(?:\[(.*?)[@-~]|\].*?(?:\007|\033\\))/g;let n=0;t.carriageReturn&&("\n"!==o&&e.removeChild(e.lastChild),t.carriageReturn=!1),o.includes("\r")&&(t.carriageReturn=!0);const s=document.createElement("span");s.classList.add("line"),e.appendChild(s);const l=e=>{if(""===e)return;const o=document.createElement("span");if(t.bold&&o.classList.add("log-bold"),t.italic&&o.classList.add("log-italic"),t.underline&&o.classList.add("log-underline"),t.strikethrough&&o.classList.add("log-strikethrough"),t.secret&&o.classList.add("log-secret"),null!==t.foregroundColor&&o.classList.add(`log-fg-${t.foregroundColor}`),null!==t.backgroundColor&&o.classList.add(`log-bg-${t.backgroundColor}`),o.appendChild(document.createTextNode(e)),s.appendChild(o),t.secret){const e=document.createElement("span");e.classList.add("log-secret-redacted"),e.appendChild(document.createTextNode("[redacted]")),s.appendChild(e)}};for(;;){const e=a.exec(o);if(null===e)break;const s=e.index;if(l(o.substring(n,s)),n=s+e[0].length,void 0!==e[1])for(const o of e[1].split(";"))switch(parseInt(o)){case 0:t.bold=!1,t.italic=!1,t.underline=!1,t.strikethrough=!1,t.foregroundColor=null,t.backgroundColor=null,t.secret=!1;break;case 1:t.bold=!0;break;case 3:t.italic=!0;break;case 4:t.underline=!0;break;case 5:t.secret=!0;break;case 6:t.secret=!1;break;case 9:t.strikethrough=!0;break;case 22:t.bold=!1;break;case 23:t.italic=!1;break;case 24:t.underline=!1;break;case 29:t.strikethrough=!1;break;case 30:t.foregroundColor="black";break;case 31:t.foregroundColor="red";break;case 32:t.foregroundColor="green";break;case 33:t.foregroundColor="yellow";break;case 34:t.foregroundColor="blue";break;case 35:t.foregroundColor="magenta";break;case 36:t.foregroundColor="cyan";break;case 37:t.foregroundColor="white";break;case 39:t.foregroundColor=null;break;case 41:t.backgroundColor="red";break;case 42:t.backgroundColor="green";break;case 43:t.backgroundColor="yellow";break;case 44:t.backgroundColor="blue";break;case 45:t.backgroundColor="magenta";break;case 46:t.backgroundColor="cyan";break;case 47:t.backgroundColor="white";break;case 40:case 49:t.backgroundColor=null}}l(o.substring(n)),e.scrollTop+56>=e.scrollHeight-e.offsetHeight&&(e.scrollTop=e.scrollHeight)})(this.logElement,t,a.data):"exit"===a.event&&(this.onProcessExit(this.modalElement,a.code),o=!0)})),a.addEventListener("open",(()=>{const e=JSON.stringify(this._encodeSpawnMessage(this.activeFilename));a.send(e)})),a.addEventListener("close",(()=>{o||this.onSocketClose(this.modalElement)}))}_onKeyDown(e){27===e.keyCode&&this.modalInstance.close()}_encodeSpawnMessage(e){return{type:"spawn",configuration:e,port:d()}}}new r({name:"logs",onPrepare:(e,t)=>{e.querySelector("[data-action='stop-logs']").innerHTML="Stop"},onProcessExit:(e,t)=>{0===t?M.toast({html:"Program exited successfully",displayLength:1e4}):M.toast({html:`Program failed with code ${t}`,displayLength:1e4}),modalElem.querySelector("data-action='stop-logs'").innerHTML="Close"},onSocketClose:e=>{M.toast({html:"Terminated process",displayLength:1e4})}}).setup();const c=new r({name:"upload",onPrepare:(e,t)=>{e.querySelector("#js-upload-modal [data-action='download-binary']").classList.add("disabled"),e.querySelector("#js-upload-modal [data-action='upload']").setAttribute("data-filename",t),e.querySelector("#js-upload-modal [data-action='upload']").classList.add("disabled"),e.querySelector("#js-upload-modal [data-action='edit']").setAttribute("data-filename",t),e.querySelector("#js-upload-modal [data-action='stop-logs']").innerHTML="Stop"},onProcessExit:(e,t)=>{0===t?(M.toast({html:"Program exited successfully",displayLength:1e4}),e.querySelector("#js-upload-modal [data-action='download-binary']").classList.remove("disabled")):(M.toast({html:`Program failed with code ${t}`,displayLength:1e4}),e.querySelector("#js-upload-modal [data-action='upload']").classList.add("disabled"),e.querySelector("#js-upload-modal [data-action='upload']").classList.remove("disabled")),e.querySelector("#js-upload-modal [data-action='stop-logs']").innerHTML="Close"},onSocketClose:e=>{M.toast({html:"Terminated process",displayLength:1e4})},dismissible:!1});document.querySelector("#js-upload-modal [data-action='download-binary']").addEventListener("click",(()=>{const e=document.createElement("a");e.download=name,e.href=`./download.bin?configuration=${encodeURIComponent(c.activeFilename)}`,document.body.appendChild(e),e.click(),e.remove()}));const u=new r({name:"validate",onPrepare:(e,t)=>{e.querySelector("#js-validate-modal [data-action='stop-logs']").innerHTML="Stop",e.querySelector("#js-validate-modal [data-action='edit']").setAttribute("data-filename",t),e.querySelector("#js-validate-modal [data-action='upload']").setAttribute("data-filename",t),e.querySelector("#js-validate-modal [data-action='upload']").classList.add("disabled")},onProcessExit:(e,t)=>{0===t?(M.toast({html:`<code class="inlinecode">${u.activeFilename}</code> is valid üëç`,displayLength:1e4}),e.querySelector("#js-validate-modal [data-action='upload']").classList.remove("disabled")):M.toast({html:`<code class="inlinecode">${u.activeFilename}</code> is invalid üòï`,displayLength:1e4}),e.querySelector("#js-validate-modal [data-action='stop-logs']").innerHTML="Close"},onSocketClose:e=>{M.toast({html:"Terminated process",displayLength:1e4})}});u.setup();const m=new r({name:"compile",onPrepare:(e,t)=>{e.querySelector("#js-compile-modal [data-action='stop-logs']").innerHTML="Stop",e.querySelector("#js-compile-modal [data-action='download-binary']").classList.add("disabled")},onProcessExit:(e,t)=>{0===t?(M.toast({html:"Program exited successfully",displayLength:1e4}),e.querySelector("#js-compile-modal [data-action='download-binary']").classList.remove("disabled")):M.toast({html:`Program failed with code ${data.code}`,displayLength:1e4}),e.querySelector("#js-compile-modal [data-action='stop-logs']").innerHTML="Close"},onSocketClose:e=>{M.toast({html:"Terminated process",displayLength:1e4})},dismissible:!1});document.querySelector("#js-compile-modal [data-action='download-binary']").addEventListener("click",(()=>{const e=document.createElement("a");e.download=name,e.href=`./download.bin?configuration=${encodeURIComponent(m.activeFilename)}`,document.body.appendChild(e),e.click(),e.remove()}));new r({name:"clean-mqtt",onPrepare:(e,t)=>{e.querySelector("#js-clean-mqtt-modal [data-action='stop-logs']").innerHTML="Stop"},onProcessExit:(e,t)=>{0===t?M.toast({html:"Program exited successfully",displayLength:1e4}):M.toast({html:`Program failed with code ${t}`,displayLength:1e4}),e.querySelector("#js-clean-mqtt-modal [data-action='stop-logs']").innerHTML="Close"},onSocketClose:e=>{M.toast({html:"Terminated process",displayLength:1e4})}}).setup();new r({name:"clean",onPrepare:(e,t)=>{e.querySelector("#js-clean-modal [data-action='stop-logs']").innerHTML="Stop"},onProcessExit:(e,t)=>{0===t?M.toast({html:"Program exited successfully",displayLength:1e4}):M.toast({html:`Program failed with code ${t}`,displayLength:1e4}),e.querySelector("#js-clean-modal [data-action='stop-logs']").innerHTML="Close"},onSocketClose:e=>{M.toast({html:"Terminated process",displayLength:1e4})}}).setup();new r({name:"update-all",onPrepare:(e,t)=>{e.querySelector("#js-update-all-modal [data-action='stop-logs']").innerHTML="Stop",e.querySelector("#js-update-all-modal #js-node-filename").style.visibility="hidden"},onProcessExit:(e,t)=>{0===t?(M.toast({html:"Program exited successfully",displayLength:1e4}),downloadButton.classList.remove("disabled")):M.toast({html:`Program failed with code ${data.code}`,displayLength:1e4}),e.querySelector("#js-update-all-modal [data-action='stop-logs']").innerHTML="Close"},onSocketClose:e=>{M.toast({html:"Terminated process",displayLength:1e4})},dismissible:!1}).setup();let p=null,h=!1,g=null,y=!1,f=!1;const b=document.querySelector("#js-editor-modal #js-editor-area"),S=ace.edit(b);S.setOptions({highlightActiveLine:!0,showPrintMargin:!0,useSoftTabs:!0,tabSize:2,useWorker:!1,theme:"ace/theme/dreamweaver",mode:"ace/mode/yaml"}),S.commands.addCommand({name:"saveCommand",bindKey:{win:"Ctrl-S",mac:"Command-S"},exec:function(){w(p)},readOnly:!1}),document.querySelectorAll("[data-action='edit']").forEach((e=>{e.addEventListener("click",(e=>{p=e.target.dataset.filename;document.querySelector("#js-editor-modal #js-node-filename").innerHTML=p;const t=document.querySelector("#js-editor-modal [data-action='save']"),o=document.querySelector("#js-editor-modal [data-action='upload']"),a=document.querySelector("#js-editor-modal [data-action='close']");t.setAttribute("data-filename",p),o.setAttribute("data-filename",p),o.setAttribute("onClick",`saveFile("${p}")`),"secrets.yaml"===p?(o.classList.add("disabled"),h=!0):(o.classList.remove("disabled"),h=!1),a.setAttribute("data-filename",p);const n=document.querySelector("#js-editor-modal #js-loading-indicator"),s=document.querySelector("#js-editor-modal #js-editor-area");n.style.display="block",s.style.display="none",S.setOption("readOnly",!0),fetch(`./edit?configuration=${p}`,{credentials:"same-origin"}).then((e=>e.text())).then((e=>{S.setValue(e,-1),S.setOption("readOnly",!1),n.style.display="none",s.style.display="block"})),S.focus();const l=document.getElementById("js-editor-modal");M.Modal.init(l,{onOpenStart:function(){},onCloseStart:function(){L()},dismissible:!1}).open()}))}));const L=()=>{p=null},k=()=>{g=new WebSocket(`${o}ace`),g.addEventListener("message",(e=>{const t=JSON.parse(e.data);if("line"===t.event){const e=JSON.parse(t.data);if("result"===e.type){const t=[];for(const o of e.validation_errors){let e={text:o.message,type:"error",row:0,column:0};null!=o.range&&(e.row=o.range.start_line,e.column=o.range.start_col),t.push(e)}for(const o of e.yaml_errors)t.push({text:o.message,type:"error",row:0,column:0});S.session.setAnnotations(t),t.length?document.querySelector("#js-editor-modal [data-action='upload']").classList.add("disabled"):document.querySelector("#js-editor-modal [data-action='upload']").classList.remove("disabled"),f=!1}else"read_file"===e.type&&v({type:"file_response",content:S.getValue()})}})),g.addEventListener("open",(()=>{const e=JSON.stringify({type:"spawn"});g.send(e)})),g.addEventListener("close",(()=>{g=null,setTimeout(k,5e3)}))},v=e=>{let t=JSON.stringify({type:"stdin",data:JSON.stringify(e)+"\n"});g.send(t)};S.session.on("change",((e,t)=>{let o;return function(){let a=this,n=arguments,s=function(){o=null,e.apply(a,n)};clearTimeout(o),o=setTimeout(s,t)}})((()=>{y=!h}),250)),setInterval((()=>{y&&!f&&null!=g&&(v({type:"validate",file:p}),f=!0,y=!1)}),100);const w=e=>{const t=new RegExp("(?:.([^.]+))?$");".yaml"===e.match(t)[0]?fetch(`./edit?configuration=${e}`,{credentials:"same-origin",method:"POST",body:S.getValue()}).then((e=>{e.text()})).then((()=>{M.toast({html:`‚úÖ Saved <code class="inlinecode">${e}</code>`,displayLength:1e4})})).catch((t=>{M.toast({html:`‚ùå An error occured saving <code class="inlinecode">${e}</code>`,displayLength:1e4})})):M.toast({html:`‚ùå File <code class="inlinecode">${e}</code> cannot be saved as it is not a YAML file!`,displayLength:1e4})};document.querySelectorAll("[data-action='save']").forEach((e=>{e.addEventListener("click",(e=>{w(p)}))})),document.querySelectorAll("[data-action='delete']").forEach((e=>{e.addEventListener("click",(e=>{const t=e.target.getAttribute("data-filename");fetch(`./delete?configuration=${t}`,{credentials:"same-origin",method:"POST"}).then((e=>{e.text()})).then((()=>{const e=`<span>üóëÔ∏è Deleted <code class="inlinecode">${t}</code>\n                           <button class="btn-flat toast-action">Undo</button>`,o=M.toast({html:e,displayLength:1e4}).el.querySelector(".toast-action");document.querySelector(`.card[data-filename="${t}"]`).remove(),o.addEventListener("click",(()=>{fetch(`./undo-delete?configuration=${t}`,{credentials:"same-origin",method:"POST"}).then((e=>{e.text()})).then((()=>{window.location.reload(!1)}))}))}))}))}));const C=async(e,t)=>{t||(t={}),t.credentials="same-origin";const o=await fetch(e,t);if(!o.ok)throw new Error(`Request not successful (${o.status})`);return"application/json"===o.headers.get("content-type")?o.json():o.text()};let q,E;const j=[],T=e=>{j.push(e);const t=()=>{const t=j.indexOf(e);-1!==t&&(j.splice(t),0===j.length&&(clearTimeout(q),q=void 0,E=void 0))};if(j.length>1){if(E){const t=E;setTimeout((()=>e(t)),0)}return t}return q=window.setTimeout(P,2e3),t},P=async()=>{const e=(new Date).getTime()+2e3;try{E=await C("./ping");for(const e of j)e(E)}finally{if(void 0!==q){const t=Math.max(0,e-(new Date).getTime());q=window.setTimeout(P,t)}}},x=()=>import("./c.aae266a4.js"),A=async e=>{x();const t=document.createElement("esphome-install-dialog");t.filename=e.target.dataset.filename,document.body.append(t)},H=()=>import("./c.37d464ef.js"),O=async()=>{H(),document.body.append(document.createElement("esphome-wizard-dialog"))};document.querySelectorAll("[data-action='wizard']").forEach((e=>{e.addEventListener("click",O),e.addEventListener("mouseover",H,{once:!0})})),T((e=>{for(let t in e){let o=document.querySelector(`#nodes .card[data-filename="${t}"]`);if(null===o)continue;let a,n=e[t];if(null===n)a="status-unknown";else if(!0===n)a="status-online",o.setAttribute("data-last-connected",Date.now().toString());else if(o.hasAttribute("data-last-connected")){const e=parseInt(o.getAttribute("data-last-connected"));a=Date.now()-e<=5e3?"status-not-responding":"status-offline"}else a="status-offline";o.classList.contains(a)||(o.classList.remove("status-unknown","status-online","status-offline","status-not-responding"),o.classList.add(a))}})),document.querySelectorAll("[data-action='upload']").forEach((e=>{e.addEventListener("click",A),e.addEventListener("mouseover",x,{once:!0})}));export{m as c,C as f,T as s,c as u};
