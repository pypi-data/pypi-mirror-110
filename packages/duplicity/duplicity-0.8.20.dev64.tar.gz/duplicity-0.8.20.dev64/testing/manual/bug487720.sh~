#!/bin/sh
set -x -e

for x in 0 1 2 3 4 5 6 7 8 9; do
    rm -r /tmp/target

    # ----- making initial backup -----
    PYTHONPATH=. bin/duplicity --no-encr --no-print -v0 --name=foo /usr/bin file:///tmp/target --volsize=2 &
    pid=$!
    sleep 10

    # ----- kill after 10 seconds ------
    kill -9 $pid &> /dev/null

    # ----- restarting first backup -----
    PYTHONPATH=. bin/duplicity --no-encr --no-print -v0 --name=foo /usr/bin file:///tmp/target --volsize=2

    # ----- verifying backup -----
    PYTHONPATH=. bin/duplicity verify --no-encr --no-print -v0 --name=foo file:///tmp/target /usr/bin --volsize=2

    if [ $# != 0 ] ; then
	echo "----- Guh!  We hit the bug! -----"
	exit $#
    else
	echo "----- Yay!  We didn't hit the bug! -----"
    fi
done
